enum Role {
  PATIENT
  PROVIDER
  ADVOCATE
  ADMIN
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  SYSTEM
}

enum InviteStatus {
  PENDING
  APPROVED
  DECLINED
}

type User
  @model
  @auth(
    rules: [
      {
        allow: owner
        ownerField: "id"
        identityClaim: "sub"
        operations: [read, update]
      }
      { allow: private, operations: [create, read] }
      {
        allow: groups
        groups: ["Admin"]
        operations: [create, read, update, delete]
      }
    ]
  ) {
  id: ID!
  email: AWSEmail!
  displayName: String!
  role: Role!
  avatarKey: String
}

type Conversation
  @model
  @auth(
    rules: [
      {
        allow: owner
        ownerField: "memberIds"
        identityClaim: "sub"
        operations: [read, update]
      }
      {
        allow: owner
        ownerField: "createdBy"
        identityClaim: "sub"
        operations: [read, update, delete]
      }
      { allow: private, operations: [create] }
      {
        allow: groups
        groups: ["Admin"]
        operations: [create, read, update, delete]
      }
    ]
  ) {
  id: ID!
  title: String
  isGroup: Boolean!
  memberIds: [String!]!
  createdBy: String!
  messages: [Message] @hasMany(indexName: "byConversation", fields: ["id"])
  createdAt: AWSDateTime
}

type Message
  @model
  @auth(
    rules: [
      {
        allow: owner
        ownerField: "memberIds"
        identityClaim: "sub"
        operations: [read]
      }
      {
        allow: owner
        ownerField: "senderId"
        identityClaim: "sub"
        operations: [create, read,  update, delete]
      }
      {
        allow: groups
        groups: ["Admin"]
        operations: [create, read, update, delete]
      }
    ]
  ) {
  id: ID!
  conversationId: ID!
    @index(
      name: "byConversation"
      queryField: "messagesByConversation"
      sortKeyFields: ["createdAt"]
    )
  senderId: String!
  memberIds: [String!]!
  type: MessageType!
  body: String
  mediaKey: String
  thumbnailKey: String
  createdAt: AWSDateTime
}

type AdvocateInvite
  @model
  @auth(
    rules: [
      {
        allow: owner
        ownerField: "patientId"
        identityClaim: "sub"
        operations: [read, update]
      }
      {
        allow: owner
        ownerField: "advocateId"
        identityClaim: "sub"
        operations: [read, update]
      }
      {
        allow: owner
        ownerField: "createdBy"
        identityClaim: "sub"
        operations: [create, read]
      }
      {
        allow: groups
        groups: ["Admin"]
        operations: [create, read, update, delete]
      }
    ]
  ) {
  id: ID!
  patientId: String!
  advocateId: String!
  conversationId: ID!
  status: InviteStatus!
  createdBy: String!
  approvedBy: String
  approvedAt: AWSDateTime
}

type Mutation {
  approveInvite(inviteId: ID!): AdvocateInvite
    @function(name: "approveInvite-${env}")
}

enum CallStatus {
  RINGING
  CONNECTED
  ENDED
}

enum SignalType {
  OFFER
  ANSWER
  ICE
  BYE
  DECLINED
}

type CallSession
  @model
  @auth(
    rules: [
      {
        allow: owner
        ownerField: "createdBy"
        identityClaim: "sub"
        operations: [create, read, update, delete]
      }
      {
        allow: owner
        ownerField: "participantIds"
        identityClaim: "sub"
        operations: [read, update]
      }
      { allow: private, operations: [read] }
    ]
  ) {
  id: ID!

  conversationId: ID!
    @index(
      name: "byConversation"
      queryField: "callSessionsByConversation"
      sortKeyFields: ["createdAt"]
    )

  participantIds: [ID!]!
  createdBy: ID!
  status: CallStatus!
  startedAt: AWSDateTime
  endedAt: AWSDateTime
  createdAt: AWSDateTime
  updatedAt: AWSDateTime
}

type CallSignal
  @model
  @auth(
    rules: [
      {
        allow: owner
        ownerField: "senderId"
        identityClaim: "sub"
        operations: [create, read]
      }
      { allow: private, operations: [read] }
    ]
  ) {
  id: ID!

  conversationId: ID!
    @index(
      name: "byConversation"
      queryField: "callSignalsByConversation"
      sortKeyFields: ["createdAt"]
    )

  callSessionId: ID!
  senderId: ID!
  type: SignalType!
  payload: AWSJSON!
  createdAt: AWSDateTime
  updatedAt: AWSDateTime
}

type Subscription {
  onSignal(conversationId: ID!): CallSignal
    @aws_subscribe(mutations: ["createCallSignal"])
}
